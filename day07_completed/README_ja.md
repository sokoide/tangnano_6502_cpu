# Day 07: メモリインターフェースとスタック

## 学習目標

Day 07では、6502 CPUシステムの重要なコンポーネントであるメモリインターフェースとスタック管理を実装します。

### 今日学ぶこと

1. **メモリマッピング**
   - RAM、ROM、I/Oの address space 分割
   - チップセレクト信号の生成
   - アドレスデコーディング

2. **メモリインターフェース**
   - メモリ読み書きの制御
   - 適切なタイミング制御
   - 外部メモリとの接続

3. **スタックポインタ管理**
   - 6502のスタック動作（$01FF から下向きに成長）
   - PUSHとPOP操作
   - スタックオーバーフロー/アンダーフロー検出

4. **メモリコントローラー**
   - CPUとスタック操作の調停
   - 優先順位制御
   - 統合されたメモリアクセス

## 実装内容

### 1. Memory Interface (`memory_interface.sv`)

```systemverilog
// メモリマップ
// $0000-$7FFF: RAM (32KB)
// $8000-$BFFF: I/O space (16KB)
// $C000-$FFFF: ROM (16KB)
```

- アドレスデコーディング
- メモリ読み書きステートマシン
- 外部メモリとの適切なインターフェース

### 2. Stack Pointer (`stack_pointer.sv`)

```systemverilog
// 6502スタックの特徴
// - Page 1 ($0100-$01FF) に固定
// - $01FF から開始して下向きに成長
// - SP は下位8ビットのみ
```

- スタック操作（PUSH/POP）
- オーバーフロー/アンダーフロー検出
- 適切なアドレス生成

### 3. Memory Controller (`memory_controller.sv`)

- CPUとスタック操作の統合
- メモリアクセスの優先順位制御
- シンプルなRAMとROMモジュール

### 4. Test System (`top.sv`)

実際のメモリシステムをテストするデモンストレーション：

- RAM読み書きテスト
- ROM読み込みテスト
- スタック操作テスト
- アドレスマッピング確認

## ビルドと実行

### 必要なファイル

- `memory_interface.sv` - メモリインターフェース制御
- `stack_pointer.sv` - スタックポインタ管理
- `memory_controller.sv` - 統合メモリコントローラー
- `simple_ram.sv` - シンプルRAMモジュール
- `simple_rom.sv` - シンプルROMモジュール
- `top.sv` - テストシステム
- `tb_memory_system.sv` - テストベンチ
- `Makefile` - ビルドシステム

### ビルドコマンド

```bash
# Tang Nano 9K用ビルド
make tang_nano_9k

# Tang Nano 20K用ビルド
make tang_nano_20k

# シミュレーション実行
make run_sim

# FPGAへの書き込み
make program_9k    # Tang Nano 9K
make program_20k   # Tang Nano 20K
```

## デバッグ出力

Tang NanoのLEDやピンでモニターできる信号：

- `debug_mem_addr[15:0]` - 現在のメモリアドレス
- `debug_mem_data[7:0]` - メモリデータ
- `debug_mem_read` - メモリ読み取り信号
- `debug_mem_write` - メモリ書き込み信号
- `debug_stack_ptr[7:0]` - スタックポインタ値
- `debug_stack_push/pop` - スタック操作信号

## テストシーケンス

スイッチで制御できるテストパターン：

1. **RAM書き込みテスト** - テストデータをRAMに書き込み
2. **RAM読み込みテスト** - RAMからデータを読み取り
3. **ROM読み込みテスト** - ROMからプログラムデータを読み取り
4. **スタックプッシュテスト** - データをスタックにプッシュ
5. **スタックポップテスト** - スタックからデータをポップ
6. **ゼロページアクセス** - ゼロページメモリの読み書き
7. **スタックページアクセス** - スタックページの直接アクセス

## 学習ポイント

### メモリマッピングの理解

6502システムの標準的なメモリレイアウト：
- **ゼロページ** ($0000-$00FF): 高速アクセス
- **スタックページ** ($0100-$01FF): スタック専用
- **RAM領域** ($0200-$7FFF): 一般的なデータとプログラム
- **I/O領域** ($8000-$BFFF): 周辺機器
- **ROM領域** ($C000-$FFFF): プログラムと割り込みベクター

### スタック操作の詳細

```systemverilog
// PUSH操作: SP-- してからデータを書き込み
// POP操作:  データを読み取ってからSP++
```

### メモリアクセスタイミング

- 適切なセットアップ/ホールドタイム
- チップセレクト信号の制御
- 読み書き信号の同期

## 次のステップ

Day 08では、これまでに作成した全コンポーネントを統合して、完全な6502 CPU coreを実装します。

## 参考資料

- 6502 Memory Map 設計ガイド
- Tang Nanoメモリインターフェース仕様
- SystemVerilogメモリモデリング
- FPGA RAM/ROM実装パターン