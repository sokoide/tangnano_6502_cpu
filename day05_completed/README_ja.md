# Day 05 Completed: 6502 命令セットとアドレッシングモード

6502の13種類のアドレッシングモードと完全な命令デコードの実装です。

## ファイル構成

- `addressing_mode_calculator.sv` - アドレッシングモード計算器
- `instruction_decoder.sv` - 拡張命令デコーダ
- `branch_calculator.sv` - 分岐計算器
- `top.sv` - 統合テストモジュール
- `tb_addressing_modes.sv` - アドレッシングモードテストベンチ
- `Makefile` - ビルド・テスト自動化

## 実装機能

### 1. アドレッシングモード計算器
**対応する13種類のアドレッシングモード:**

1. **Immediate** - `#$nn` (即値)
2. **Zero Page** - `$nn` (ゼロページ)
3. **Zero Page,X** - `$nn,X` (ゼロページ+X)
4. **Zero Page,Y** - `$nn,Y` (ゼロページ+Y)
5. **Absolute** - `$nnnn` (絶対アドレス)
6. **Absolute,X** - `$nnnn,X` (絶対+X)
7. **Absolute,Y** - `$nnnn,Y` (絶対+Y)
8. **Indirect** - `($nnnn)` (間接)
9. **Indexed Indirect** - `($nn,X)` (インデックス間接)
10. **Indirect Indexed** - `($nn),Y` (間接インデックス)
11. **Relative** - 分岐命令用相対アドレス
12. **Implied** - オペランドなし
13. **Accumulator** - Aレジスタ操作

**機能:**
- 有効アドレス計算
- 命令長判定 (1-3バイト)
- ページ境界越え検出
- リトルエンディアン対応

### 2. 拡張命令デコーダ
**命令分類:**
- Load/Store命令 (LDA, STA, LDX, STX, LDY, STY)
- 演算命令 (ADC, SBC)
- 論理演算 (AND, ORA, EOR)
- シフト命令 (ASL, LSR, ROL, ROR)
- 転送命令 (TAX, TAY, TXA, TYA)
- 分岐命令 (BEQ, BNE, BPL, BMI等)
- ジャンプ命令 (JMP, JSR, RTS)
- 比較命令 (CMP, CPX, CPY)
- フラグ命令 (SEC, CLC等)
- スタック命令 (PHA, PLA等)

**出力情報:**
- 使用レジスタ (A, X, Y)
- 影響フラグ (N, Z, C, V)
- メモリアクセス (読み/書き)

### 3. 分岐計算器
**分岐命令:**
- BPL/BMI (正負判定)
- BVC/BVS (オーバーフロー)
- BCC/BCS (キャリー)
- BNE/BEQ (ゼロ判定)

**機能:**
- 符号付き8bitオフセット処理
- 分岐条件評価
- ページ境界越え検出

## ビルド・テスト方法

### シミュレーションテスト
```bash
make test
```

### FPGAビルド
```bash
# Tang Nano 9K
make BOARD=9k download

# Tang Nano 20K
make BOARD=20k download
```

## テスト内容

アドレッシングモードテストベンチで以下をテスト:

1. **即値アドレッシング**: `LDA #$55`
2. **ゼロページ**: `LDA $80`
3. **ゼロページインデックス**: `LDA $80,X`
4. **絶対アドレス**: `LDA $1234`
5. **絶対インデックス**: `LDA $1234,X` (ページ境界越え含む)
6. **分岐命令**: `BPL +5`, `BNE -5`
7. **ゼロページラップアラウンド**: `LDA $FF,X`

## ハードウェア動作確認

### 入力
- `rst_n`: リセットボタン
- `switches[3:0]`: テスト制御
  - `switches[3]=0`: 自動デモモード
  - `switches[3]=1`: 手動選択モード (switches[2:0]で命令選択)

### 出力
- `debug_addr_low[7:0]`: 有効アドレス下位
- `debug_addr_high[7:0]`: 有効アドレス上位
- `debug_addr_mode[2:0]`: アドレッシングモード番号
- `debug_inst_length[1:0]`: 命令長
- `debug_page_crossed`: ページ境界越えフラグ
- `led_load/store/arithmetic/branch`: 命令タイプ表示

### デモシーケンス
16種類の命令を順番に実行し、各アドレッシングモードの動作を確認:

1. `LDA #$55` (即値)
2. `LDA $80` (ゼロページ)
3. `LDA $80,X` (ゼロページ,X)
4. `LDA $1234` (絶対)
5. `LDA $1234,X` (絶対,X)
6. `LDA $1234,Y` (絶対,Y)
7. `STA $90` (ストア)
8. `ADC #$10` (演算)
9. `JMP $3000` (ジャンプ)
10. `BPL +5` (分岐)
11. `TAX` (転送)
12. その他の複雑なアドレッシング

## 学習ポイント

### 6502アドレッシングの特徴
- **ゼロページの高速性**: 2バイト命令で高速アクセス
- **インデックスレジスタ**: X/Yによる配列アクセス
- **間接アドレッシング**: ポインタ操作
- **ページ境界越え**: 追加サイクルが必要
- **リトルエンディアン**: 下位→上位の順序

### 実装技術
- 複雑なアドレス計算ロジック
- 条件分岐による命令分類
- ページ境界検出アルゴリズム
- 包括的なテストベンチ設計

### デバッグ手法
- 実時間でのアドレス計算確認
- 命令タイプの可視化
- ページ境界越えの監視
- シミュレーションによる詳細検証

## 発展課題

1. **間接アドレッシングの完全実装**: メモリ読み出しを含む実装
2. **サイクル数計算**: 各アドレッシングモードの実行サイクル数
3. **不正アドレス検出**: 無効なアドレスアクセスの検出

この実装により、6502の柔軟なアドレッシング機能を完全に理解し、次のステップのCPU実装に向けた基盤が整いました。